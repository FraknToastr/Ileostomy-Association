<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QR Code Generator — Full Features</title>

<script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>

<style>
    :root {
        --bg: #f2f2f2;
        --card: #ffffff;
        --text: #222;
        --input-bg: #fff;
        --input-border: #ccc;
    }
    body.dark {
        --bg: #1b1b1b;
        --card: #2a2a2a;
        --text: #eee;
        --input-bg: #333;
        --input-border: #555;
    }

    body {
        background: var(--bg);
        font-family: Arial, sans-serif;
        padding: 20px;
        display: flex;
        justify-content: center;
        color: var(--text);
    }

    .container {
        width: 450px;
        background: var(--card);
        padding: 20px;
        border-radius: 14px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }

    h2 { text-align: center; margin-top: 0; }

    label {
        font-weight: bold;
        margin-top: 12px;
        display: block;
    }

    input[type="text"],
    input[type="file"],
    select,
    input[type="range"] {
        width: 100%;
        padding: 10px;
        margin-top: 6px;
        border-radius: 8px;
        border: 1px solid var(--input-border);
        background: var(--input-bg);
        color: var(--text);
        box-sizing: border-box;
        max-width: 100%;
        display: block;
    }

    .color-row { display: flex; gap: 10px; }
    .color-row div { flex: 1; }

    button {
        width: 100%;
        background: #0078ff;
        padding: 12px;
        margin-top: 16px;
        border: none;
        border-radius: 8px;
        color: white;
        cursor: pointer;
        font-size: 16px;
    }

    button:hover { background: #0060cc; }

    #themeToggle { margin-bottom: 12px; background: #444; }

    .preview {
        margin-top: 20px;
        text-align: center;
    }

    canvas {
        background: var(--card);
        border-radius: 12px;
        padding: 10px;
    }
</style>
</head>
<body>

<div class="container">

    <button id="themeToggle">Toggle Dark/Light</button>

    <h2>QR Code Generator</h2>

    <label>Text or URL</label>
    <input id="qrInput" type="text" placeholder="Enter text or URL">

    <label>Logo (optional)</label>
    <input id="logoInput" type="file" accept="image/*" onchange="drawLogoAndSafeZone()">

    <label>Error Correction Level</label>
    <select id="qrLevel">
        <option value="L">L — Low</option>
        <option value="M">M — Medium</option>
        <option value="Q">Q — Quartile</option>
        <option value="H" selected>H — High</option>
    </select>

    <div class="color-row">
        <div>
            <label>QR Colour</label>
            <input type="color" id="qrColor" value="#000000">
        </div>
        <div>
            <label>Background</label>
            <input type="color" id="qrBG" value="#ffffff">
        </div>
    </div>

    <label>Logo Size (% of QR)</label>
    <input id="logoSize" type="range" min="10" max="30" value="20" oninput="drawLogoAndSafeZone()">

    <label>Safe Zone (px)</label>
    <input id="safeZone" type="range" min="0" max="40" value="6" oninput="drawLogoAndSafeZone()">

    <label>Export Size</label>
    <select id="exportSize">
        <option value="1024">1024 px</option>
        <option value="2048">2048 px</option>
        <option value="4096">4096 px</option>
    </select>

    <button onclick="generateQR()">Generate QR</button>

    <button onclick="exportPNG()">Download PNG</button>
    <button onclick="exportSVG()">Download SVG</button>

    <button onclick="saveStyle()">Save Style</button>
    <button onclick="loadStyle()">Load Style</button>

    <div class="preview">
        <canvas id="qrCanvas" width="300" height="300"></canvas>
    </div>
</div>

<script>
    const canvas = document.getElementById("qrCanvas");
    const ctx = canvas.getContext("2d");

    const themeToggle = document.getElementById("themeToggle");
    themeToggle.onclick = () => document.body.classList.toggle("dark");

    // Base QR encoder (off the visible canvas)
    let qr = new QRious({
        value: "",
        size: 300,
        level: "H",
        foreground: "#000000",
        background: "#ffffff"
    });

    function drawBaseQR() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(qr.canvas, 0, 0, canvas.width, canvas.height);
    }

    function generateQR() {
        const text = document.getElementById("qrInput").value.trim();
        if (!text) {
            ctx.clearRect(0,0,canvas.width,canvas.height);
            return;
        }

        qr.set({
            value: text,
            foreground: document.getElementById("qrColor").value,
            background: document.getElementById("qrBG").value,
            level: document.getElementById("qrLevel").value
        });

        drawLogoAndSafeZone();
    }

    // --- Draw logo + safe zone on preview (called by Generate + sliders + logo change) ---
    function drawLogoAndSafeZone() {
        // Always draw the QR first
        drawBaseQR();

        const logoInput = document.getElementById("logoInput");
        const logoFile = logoInput.files && logoInput.files[0];
        if (!logoFile) {
            // No logo: nothing else to draw
            return;
        }

        const logoSizeSlider = document.getElementById("logoSize");
        const safeZoneSlider = document.getElementById("safeZone");

        const logo = new Image();
        logo.onload = function () {
            // Redraw QR again inside onload to avoid async race
            drawBaseQR();

            const pct  = Number(logoSizeSlider.value) / 100;
            const safe = Number(safeZoneSlider.value);

            const size = canvas.width * pct;
            const cx = canvas.width / 2;
            const cy = canvas.height / 2;
            const x  = cx - size / 2;
            const y  = cy - size / 2;

            // Safe zone: filled circle behind logo
            if (safe > 0) {
                ctx.beginPath();
                ctx.arc(cx, cy, (size / 2) + safe, 0, Math.PI * 2);
                ctx.fillStyle = document.getElementById("qrBG").value;
                ctx.fill();
            }

            // Draw logo in the centre (PNG transparency is naturally respected)
            ctx.drawImage(logo, x, y, size, size);
        };
        logo.src = URL.createObjectURL(logoFile);
    }

    // --- PNG export ---
    function exportPNG() {
        const exportSize = Number(document.getElementById("exportSize").value);
        const logoInput  = document.getElementById("logoInput");
        const logoFile   = logoInput.files && logoInput.files[0];

        const off = document.createElement("canvas");
        off.width = exportSize;
        off.height = exportSize;
        const offCtx = off.getContext("2d");

        // Render QR at export resolution
        qr.set({
            size: exportSize,
            value: document.getElementById("qrInput").value.trim(),
            foreground: document.getElementById("qrColor").value,
            background: document.getElementById("qrBG").value,
            level: document.getElementById("qrLevel").value
        });

        offCtx.drawImage(qr.canvas, 0, 0, exportSize, exportSize);

        if (!logoFile) {
            downloadCanvas(off, "png");
            // restore preview size
            qr.set({ size: 300 });
            drawLogoAndSafeZone();
            return;
        }

        const logoSizeSlider = document.getElementById("logoSize");
        const safeZoneSlider = document.getElementById("safeZone");

        const logo = new Image();
        logo.onload = function () {
            // Redraw QR at export size (safety for async)
            offCtx.clearRect(0, 0, exportSize, exportSize);
            offCtx.drawImage(qr.canvas, 0, 0, exportSize, exportSize);

            const pct  = Number(logoSizeSlider.value) / 100;
            const safe = Number(safeZoneSlider.value);

            const size = exportSize * pct;
            const cx   = exportSize / 2;
            const cy   = exportSize / 2;
            const x    = cx - size / 2;
            const y    = cy - size / 2;

            if (safe > 0) {
                offCtx.beginPath();
                offCtx.arc(cx, cy, (size / 2) + safe, 0, Math.PI * 2);
                offCtx.fillStyle = document.getElementById("qrBG").value;
                offCtx.fill();
            }

            offCtx.drawImage(logo, x, y, size, size);

            downloadCanvas(off, "png");

            // restore preview size & redraw
            qr.set({ size: 300 });
            generateQR();
        };
        logo.src = URL.createObjectURL(logoFile);
    }

    function downloadCanvas(c, format) {
        const link = document.createElement("a");
        link.download = `qr_code.${format}`;
        link.href = c.toDataURL("image/" + format);
        link.click();
    }

    // --- SVG export (no logo – as with your original behaviour) ---
    function exportSVG() {
        const text  = document.getElementById("qrInput").value.trim();
        const level = document.getElementById("qrLevel").value;
        const fg    = document.getElementById("qrColor").value;
        const bg    = document.getElementById("qrBG").value;
        const size  = Number(document.getElementById("exportSize").value);

        const svgQR = new QRious({
            value: text,
            level: level,
            foreground: fg,
            background: bg,
            size: size,
            mime: "image/svg+xml"
        });

        const link = document.createElement("a");
        link.download = "qr_code.svg";
        link.href = svgQR.toDataURL();
        link.click();
    }

    // --- Save / Load style ---
    function saveStyle() {
        const obj = {
            qrColor: document.getElementById("qrColor").value,
            qrBG: document.getElementById("qrBG").value,
            logoSize: document.getElementById("logoSize").value,
            safeZone: document.getElementById("safeZone").value,
            level: document.getElementById("qrLevel").value,
            exportSize: document.getElementById("exportSize").value,
            theme: document.body.classList.contains("dark")
        };
        localStorage.setItem("qrStyle", JSON.stringify(obj));
        alert("Style saved!");
    }

    function loadStyle() {
        const obj = JSON.parse(localStorage.getItem("qrStyle"));
        if (!obj) {
            alert("No saved style.");
            return;
        }

        document.getElementById("qrColor").value    = obj.qrColor;
        document.getElementById("qrBG").value       = obj.qrBG;
        document.getElementById("logoSize").value   = obj.logoSize;
        document.getElementById("safeZone").value   = obj.safeZone;
        document.getElementById("qrLevel").value    = obj.level;
        document.getElementById("exportSize").value = obj.exportSize;

        if (obj.theme) document.body.classList.add("dark");
        else document.body.classList.remove("dark");

        generateQR();
    }
</script>

</body>
</html>
